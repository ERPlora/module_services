{% extends "ui/app_base.html" %}
{% load static i18n ui component_tags %}

{% block page_title %}
    {% if mode == 'create' %}{% trans "New Service" %}
    {% else %}{% trans "Edit Service" %}{% endif %}
{% endblock %}

{% block page_content %}
{% ui_page_header title=_("Service") %}

<div class="ion-padding">
    {% ui_card %}
        <form id="serviceForm" method="post">
            {% csrf_token %}

            {# Basic Info #}
            <div class="form-section">
                <h3 class="form-section-title">{% trans "Basic Information" %}</h3>

                <ion-item>
                    <ion-input
                        label="{% trans 'Name' %} *"
                        label-placement="floating"
                        name="name"
                        value="{{ service.name|default:'' }}"
                        required>
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-select
                        label="{% trans 'Category' %}"
                        label-placement="floating"
                        name="category_id"
                        value="{{ service.category_id|default:'' }}"
                        interface="action-sheet"
                    >
                        <ion-select-option value="">{% trans "None" %}</ion-select-option>
                        {% for cat in categories %}
                        <ion-select-option value="{{ cat.id }}">{{ cat.name }}</ion-select-option>
                        {% endfor %}
                    </ion-select>
                </ion-item>

                <ion-item>
                    <ion-textarea
                        label="{% trans 'Description' %}"
                        label-placement="floating"
                        name="description"
                        rows="3"
                        value="{{ service.description|default:'' }}">
                    </ion-textarea>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Short Description' %}"
                        label-placement="floating"
                        name="short_description"
                        maxlength="200"
                        value="{{ service.short_description|default:'' }}">
                    </ion-input>
                </ion-item>
            </div>

            {# Pricing #}
            <div class="form-section">
                <h3 class="form-section-title">{% trans "Pricing" %}</h3>

                <ion-item>
                    <ion-select
                        label="{% trans 'Pricing Type' %}"
                        label-placement="floating"
                        name="pricing_type"
                        value="{{ service.pricing_type|default:'fixed' }}"
                        interface="popover"
                    >
                        <ion-select-option value="fixed">{% trans "Fixed Price" %}</ion-select-option>
                        <ion-select-option value="hourly">{% trans "Hourly Rate" %}</ion-select-option>
                        <ion-select-option value="from">{% trans "Starting From" %}</ion-select-option>
                        <ion-select-option value="variable">{% trans "Variable" %}</ion-select-option>
                        <ion-select-option value="free">{% trans "Free" %}</ion-select-option>
                    </ion-select>
                </ion-item>

                <div class="form-grid form-grid--2col">
                    <ion-item>
                        <ion-input
                            label="{% trans 'Price' %} (€)"
                            label-placement="floating"
                            name="price"
                            type="number"
                            step="0.01"
                            min="0"
                            value="{{ service.price|default:'0.00' }}">
                        </ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            label="{% trans 'Cost' %} (€)"
                            label-placement="floating"
                            name="cost"
                            type="number"
                            step="0.01"
                            min="0"
                            value="{{ service.cost|default:'0.00' }}">
                        </ion-input>
                    </ion-item>
                </div>

                <ion-item>
                    <ion-input
                        label="{% trans 'Tax Rate' %} (%)"
                        label-placement="floating"
                        name="tax_rate"
                        type="number"
                        step="0.01"
                        min="0"
                        max="100"
                        placeholder="{% trans 'Leave empty for default' %}"
                        value="{{ service.tax_rate|default:'' }}">
                    </ion-input>
                </ion-item>
            </div>

            {# Duration #}
            <div class="form-section">
                <h3 class="form-section-title">{% trans "Duration" %}</h3>

                <ion-item>
                    <ion-input
                        label="{% trans 'Duration (minutes)' %} *"
                        label-placement="floating"
                        name="duration_minutes"
                        type="number"
                        min="5"
                        value="{{ service.duration_minutes|default:config.default_duration }}"
                        required>
                    </ion-input>
                </ion-item>

                <div class="form-grid form-grid--2col">
                    <ion-item>
                        <ion-input
                            label="{% trans 'Buffer Before (min)' %}"
                            label-placement="floating"
                            name="buffer_before"
                            type="number"
                            min="0"
                            value="{{ service.buffer_before|default:'0' }}">
                        </ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            label="{% trans 'Buffer After (min)' %}"
                            label-placement="floating"
                            name="buffer_after"
                            type="number"
                            min="0"
                            value="{{ service.buffer_after|default:'0' }}">
                        </ion-input>
                    </ion-item>
                </div>

                <ion-item>
                    <ion-input
                        label="{% trans 'Max Capacity' %}"
                        label-placement="floating"
                        name="max_capacity"
                        type="number"
                        min="1"
                        value="{{ service.max_capacity|default:'1' }}">
                    </ion-input>
                </ion-item>
            </div>

            {# Booking Options #}
            <div class="form-section">
                <h3 class="form-section-title">{% trans "Booking Options" %}</h3>

                <ion-item>
                    <ion-toggle
                        name="is_bookable"
                        {% if service.is_bookable or mode == 'create' %}checked{% endif %}
                    >{% trans "Is Bookable" %}</ion-toggle>
                </ion-item>

                <ion-item>
                    <ion-toggle
                        name="allow_online_booking"
                        {% if service.allow_online_booking or mode == 'create' %}checked{% endif %}
                    >{% trans "Allow Online Booking" %}</ion-toggle>
                </ion-item>

                <ion-item>
                    <ion-toggle
                        name="requires_confirmation"
                        {% if service.requires_confirmation %}checked{% endif %}
                    >{% trans "Requires Confirmation" %}</ion-toggle>
                </ion-item>

                <ion-item>
                    <ion-toggle
                        name="is_featured"
                        {% if service.is_featured %}checked{% endif %}
                    >{% trans "Featured" %}</ion-toggle>
                </ion-item>

                {% if mode == 'edit' %}
                <ion-item>
                    <ion-toggle
                        name="is_active"
                        {% if service.is_active %}checked{% endif %}
                    >{% trans "Active" %}</ion-toggle>
                </ion-item>
                {% endif %}
            </div>

            {# Additional Info #}
            <div class="form-section">
                <h3 class="form-section-title">{% trans "Additional Information" %}</h3>

                <div class="form-grid form-grid--2col">
                    <ion-item>
                        <ion-input
                            label="{% trans 'SKU' %}"
                            label-placement="floating"
                            name="sku"
                            value="{{ service.sku|default:'' }}">
                        </ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            label="{% trans 'Barcode' %}"
                            label-placement="floating"
                            name="barcode"
                            value="{{ service.barcode|default:'' }}">
                        </ion-input>
                    </ion-item>
                </div>

                <div class="form-grid form-grid--2col">
                    <ion-item>
                        <ion-input
                            label="{% trans 'Icon' %}"
                            label-placement="floating"
                            name="icon"
                            placeholder="construct-outline"
                            value="{{ service.icon|default:'' }}">
                        </ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            label="{% trans 'Color' %}"
                            label-placement="floating"
                            name="color"
                            type="color"
                            value="{{ service.color|default:'#3880ff' }}">
                        </ion-input>
                    </ion-item>
                </div>

                <ion-item>
                    <ion-textarea
                        label="{% trans 'Internal Notes' %}"
                        label-placement="floating"
                        name="notes"
                        rows="3"
                        value="{{ service.notes|default:'' }}">
                    </ion-textarea>
                </ion-item>
            </div>

            {# Actions #}
            <div class="form-actions mt-lg">
                <ion-button type="submit" expand="block">
                    {% icon "save-outline" %}
                    {% trans "Save" %}
                </ion-button>
            </div>
        </form>
    {% endui_card %}
</div>

<script>
document.getElementById('serviceForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Handle toggles
    data.is_bookable = formData.has('is_bookable');
    data.allow_online_booking = formData.has('allow_online_booking');
    data.requires_confirmation = formData.has('requires_confirmation');
    data.is_featured = formData.has('is_featured');
    {% if mode == 'edit' %}
    data.is_active = formData.has('is_active');
    {% endif %}

    try {
        const response = await fetch('{% if mode == "create" %}{% url "services:create" %}{% else %}{% url "services:edit" service.pk %}{% endif %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            Alpine.store('ui').success('{% trans "Service saved successfully" %}');
            window.location.href = '{% url "services:list" %}';
        } else {
            Alpine.store('ui').error(result.error);
        }
    } catch (error) {
        Alpine.store('ui').error('{% trans "Error saving service" %}');
    }
});
</script>

{% component "tabbar" module_id="services" current_view="list" %}{% endcomponent %}
{% endblock %}
